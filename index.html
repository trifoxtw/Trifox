<!DOCTYPE html>
<html>
<head>
    <title>LINE LIFF QR Code Check-in</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        button {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #result {
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2>選擇班別進行打卡</h2>
    <button onclick="checkIn('早診上班')">早診上班</button>
    <button onclick="checkIn('早診下班')">早診下班</button>
    <button onclick="checkIn('午診上班')">午診上班</button>
    <button onclick="checkIn('午診下班')">午診下班</button>
    <button onclick="checkIn('晚診上班')">晚診上班</button>
    <button onclick="checkIn('晚診下班')">晚診下班</button>
    <div id="result"></div>

    <script>
        let userId = '';

        async function initializeLIFF() {
            try {
                await liff.init({ liffId: '2008054767-e2XRvkLr' });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userId = profile.userId;
                    console.log('User ID:', userId);
                }
            } catch (error) {
                console.error('LIFF 初始化失敗:', error);
                document.getElementById('result').innerText = 'LIFF 初始化失敗，請稍後再試。';
            }
        }

        async function checkIn(shift) {
            try {
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const result = await liff.scanCodeV2();
                const qrContent = result.value;
                console.log('QR Code 內容:', qrContent);

                // Google 表單預填連結
                const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfkXPk4mjvH78PNfsXduF8DPg3vf3fmgIfNJXtCR5aIZR69QQ/viewform';
                const prefilledUrl = `${formUrl}?entry.1366094180=${encodeURIComponent(shift)}&entry.538125100=${encodeURIComponent(userId)}&entry.1841717274=${encodeURIComponent(qrContent)}`;

                // 自動提交表單（使用 iframe 隱藏提交過程）
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = prefilledUrl;
                document.body.appendChild(iframe);

                // 顯示打卡結果
                const currentTime = new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });
                document.getElementById('result').innerText = `打卡成功！\n班別：${shift}\n時間：${currentTime}`;

                // 移除 iframe
                setTimeout(() => {
                    document.body.removeChild(iframe);
                }, 2000);
            } catch (error) {
                console.error('QR Code 掃描失敗:', error);
                document.getElementById('result').innerText = 'QR Code 掃描失敗，請重試。';
            }
        }

        // 初始化 LIFF
        initializeLIFF();
    </script>
</body>
</html>
