<!DOCTYPE html>
<html>
<head>
  <title>LINE LIFF 打卡</title>
  <script src="https://static.line-scdn.net/liff/2.22.2/liff.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    #scanBtn { padding: 15px 30px; font-size: 18px; cursor: pointer; }
    #status { margin-top: 20px; font-size: 16px; color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>每日打卡</h1>
  <button id="scanBtn">掃描 QR Code</button>
  <div id="status"></div>

  <script>
    // 載入 LIFF SDK 後，初始化
    window.onload = function() {
      liff.init({
        liffId: 'YOUR_LIFF_ID' // 將 YOUR_LIFF_ID 替換成你的 LIFF ID
      })
      .then(() => {
        // LIFF 初始化成功，檢查是否已登入
        if (!liff.isLoggedIn()) {
          liff.login(); // 如果沒登入，導向登入頁面
        } else {
          document.getElementById('scanBtn').onclick = scanQRCode;
          document.getElementById('status').innerText = 'LIFF 準備就緒！';
        }
      })
      .catch((err) => {
        console.error('LIFF 初始化失敗', err);
        document.getElementById('status').innerText = 'LIFF 初始化失敗。';
        document.getElementById('status').classList.add('error');
      });
    };

    function scanQRCode() {
      if (!liff.isApiAvailable('scanCodeV2')) {
        alert('此 LINE 版本不支援掃描功能。');
        return;
      }
      
      liff.scanCodeV2()
      .then(result => {
        if (result.value) {
          const qrCodeContent = result.value;
          document.getElementById('status').innerText = '掃描成功，正在打卡...';
          console.log('掃描到的 QR Code 內容:', qrCodeContent);

          // 將 QR Code 內容和用戶資訊發送到後端
          sendPunchInRequest(qrCodeContent);
        } else {
          document.getElementById('status').innerText = '掃描失敗或已取消。';
          document.getElementById('status').classList.add('error');
        }
      })
      .catch(err => {
        console.error('掃描失敗', err);
        document.getElementById('status').innerText = '掃描失敗，請重試。';
        document.getElementById('status').classList.add('error');
      });
    }

    function sendPunchInRequest(qrCodeContent) {
      // 獲取用戶資料
      liff.getProfile()
      .then(profile => {
        const userId = profile.userId;
        const userName = profile.displayName;
        
        // 傳送資料到後端
        fetch('https://your-backend-server.com/punch-in', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            userId: userId,
            qrCodeContent: qrCodeContent
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('status').innerText = `打卡成功！${userName}`;
            liff.closeWindow(); // 打卡成功後關閉 LIFF 視窗
          } else {
            document.getElementById('status').innerText = `打卡失敗: ${data.message}`;
            document.getElementById('status').classList.add('error');
          }
        })
        .catch(error => {
          console.error('打卡請求失敗:', error);
          document.getElementById('status').innerText = '網路請求失敗，請檢查網路。';
          document.getElementById('status').classList.add('error');
        });
      })
      .catch(err => {
        console.error('無法取得用戶資料', err);
        document.getElementById('status').innerText = '無法取得用戶資料，請重試。';
        document.getElementById('status').classList.add('error');
      });
    }
  </script>
</body>
</html>